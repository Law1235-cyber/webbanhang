{% extends 'app/base.html' %}
{% load static %}

{% block content_checkout %}
<style>
    /* CSS được chuyển thể từ mẫu Vue.js */
    .qr-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        max-width: 600px;
        /* Độ rộng vừa phải giống modal */
        margin: 0 auto;
    }

    .qr-header {
        padding: 20px;
        background: #007bff;
        color: white;
        text-align: center;
    }

    .qr-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }

    .qr-body {
        padding: 30px;
    }

    .payment-info {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        text-align: left;
        border-left: 5px solid #007bff;
    }

    .payment-info p {
        margin: 8px 0;
        color: #333;
        font-size: 15px;
    }

    .qr-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        margin: 20px 0;
    }

    .qr-instructions {
        background: #e9ecef;
        border-radius: 8px;
        padding: 15px;
        width: 100%;
        text-align: left;
        font-size: 14px;
        color: #495057;
    }

    .qr-instructions ul {
        padding-left: 20px;
        margin: 5px 0;
    }

    .qr-instructions li {
        margin-bottom: 5px;
    }

    .qr-image {
        max-width: 280px;
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        background: white;
    }

    .bank-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        width: 100%;
        text-align: left;
        font-size: 14px;
        border: 1px dashed #ced4da;
    }

    .bank-info p {
        margin: 5px 0;
        display: flex;
        justify-content: space-between;
    }

    .status-waiting {
        background: #fff3cd;
        color: #856404;
        padding: 15px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-weight: 500;
        width: 100%;
    }

    .btn-copy {
        background: none;
        border: none;
        color: #007bff;
        cursor: pointer;
        padding: 0 5px;
        font-size: 14px;
    }

    .btn-copy:hover {
        text-decoration: underline;
    }

    /* Animation cho đồng hồ đếm ngược */
    .countdown-box {
        background-color: #ffeaea;
        color: #dc3545;
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: bold;
        display: inline-block;
        margin-bottom: 15px;
    }
</style>

<div class="container" style="margin-top: 50px; margin-bottom: 50px;">
    <div class="qr-card">
        <div class="qr-header">
            <h3>Thanh toán QR Code</h3>
        </div>

        <div class="qr-body">
            <!-- Đồng hồ đếm ngược -->
            <div class="text-center">
                <div class="countdown-box">
                    Hết hạn sau: <span id="countdown">10:00</span>
                </div>
            </div>

            <!-- Thông tin đơn hàng (Giống block .payment-info trong mẫu) -->
            <div class="payment-info">
                <p><strong>Mã đơn hàng:</strong> #{{ order.id }}</p>
                <p><strong>Tổng tiền:</strong> <span class="text-danger fw-bold fs-5">
                        {{ order.total_amount|floatformat:0 }} đ     </span></p>
                {% if user.is_authenticated %}
                <div style="border-top: 1px solid #ddd; margin-top: 10px; padding-top: 10px;">
                    <p><strong>Khách hàng:</strong> {{ user.username }}</p>
                    <p><strong>Email:</strong> {{ user.email }}</p>
                </div>
                {% endif %}
            </div>

            <div class="qr-container">
                <!-- Hướng dẫn (Giống block .qr-instructions trong mẫu) -->
                <div class="qr-instructions">
                    <p><strong>Hướng dẫn quét mã:</strong></p>
                    <ul>
                        <li>Mở ứng dụng ngân hàng hoặc ví điện tử</li>
                        <li>Chọn chức năng quét mã QR</li>
                        <li>Di chuyển camera để quét mã bên dưới</li>
                    </ul>
                </div>

                <!-- Mã QR -->
                <img id="qr-image" src="" alt="Payment QR Code" class="qr-image" />

                <!-- Thông tin ngân hàng (Giống block .bank-info trong mẫu) -->
                <div class="bank-info">
                    <p>
                        <strong>Ngân hàng:</strong>
                        <span id="bank-name"></span>
                    </p>
                    <p>
                        <strong>Số tài khoản:</strong>
                        <span>
                            <span id="account-number" class="fw-bold text-primary"></span>
                            <button class="btn-copy" onclick="copyToClipboard('account-number')" title="Sao chép">Sao
                                chép</button>
                        </span>
                    </p>
                    <p>
                        <strong>Chủ tài khoản:</strong>
                        <span id="account-holder" class="fw-bold text-uppercase"></span>
                    </p>
                    <p>
                        <strong>Nội dung:</strong>
                        <span class="fw-bold text-success">DH{{ order.id }}</span>
                    </p>
                </div>
            </div>

            <!-- Trạng thái (Giống block .payment-status trong mẫu) -->
            <div class="payment-status">
                <div class="status-waiting">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span>Đang chờ thanh toán...</span>
                </div>
            </div>

            <div class="mt-4 text-center">
                <a href="{% url 'checkout' %}" class="btn btn-secondary w-100">Quay lại Checkout</a>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // CẤU HÌNH THÔNG TIN NGÂN HÀNG (SỬA TẠI ĐÂY)
    // ============================================================
    const SO_TAI_KHOAN = "962470867447890";      // Số tài khoản
    const NGAN_HANG = "BIDV";             // Tên ngân hàng
    const CHU_TAI_KHOAN = "DANG TRUNG HAI"; // Tên chủ tài khoản
    // ============================================================

    const orderId = "{{ order.id }}";
    const amount = "{{ order.total_amount|floatformat:0 }}";

    // 1. Hiển thị thông tin lên giao diện
    document.getElementById('bank-name').innerText = NGAN_HANG;
    document.getElementById('account-number').innerText = SO_TAI_KHOAN;
    document.getElementById('account-holder').innerText = CHU_TAI_KHOAN;

    // 2. Tạo mã QR tự động
    // Sử dụng link SePay như logic cũ để đảm bảo tích hợp Webhook
    const qrUrl = `https://qr.sepay.vn/img?acc=${SO_TAI_KHOAN}&bank=${NGAN_HANG}&amount=${amount}&des=DH${orderId}`;
    document.getElementById('qr-image').src = qrUrl;

    // 3. Xử lý đếm ngược 10 phút
    let timeLeft = 600;
    const countdownEl = document.getElementById('countdown');

    const timerInterval = setInterval(() => {
        const minutes = Math.floor(timeLeft / 60);
        let seconds = timeLeft % 60;
        seconds = seconds < 10 ? '0' + seconds : seconds;
        countdownEl.innerText = `${minutes}:${seconds}`;
        timeLeft--;

        if (timeLeft < 0) {
            clearInterval(timerInterval);
            alert("Giao dịch đã hết hạn.");
            window.location.href = "{% url 'checkout' %}";
        }
    }, 1000);

    // 4. Kiểm tra trạng thái thanh toán (Webhook)
    function checkOrderStatus() {
        fetch(`/api/check-payment-status/${orderId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.complete === true) {
                    window.location.href = "{% url 'payment_success' %}";
                }
            })
            .catch(error => console.error('Lỗi check status:', error));
    }

    setInterval(checkOrderStatus, 2000);

    function copyToClipboard(elementId) {
        const text = document.getElementById(elementId).innerText;
        navigator.clipboard.writeText(text).then(() => {
            alert("Đã sao chép: " + text);
        }).catch(err => {
            console.error('Lỗi sao chép', err);
        });
    }
</script>
{% endblock content_checkout %}
